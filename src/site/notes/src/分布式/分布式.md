---
{"dg-publish":true,"dg-permalink":"分布式","permalink":"/分布式/"}
---


#分布式 

## CAP 是什么？

1. CAP
	- C（*Consistency*）：一致性，每时每刻所有结点的同一份数据都是一致的
	- A（*Availability*）：**任何**时刻都可以提供服务
	- P（*Partition tolerance*）：**部分**故障不影响整体使用
2. 定理
	- 在高并发、高可用的系统中无法**同时满足**，最多只能满足其中**两**个
	- P （分区容错性）是必须的，因此一般系统都是：
		-  **CP** ：丢弃可用性，如 ZooKeeper
		-  **AP**：丢弃一致性，如 Eureka

[[src/分布式/ZooKeeper#ZooKeeper 是 CAP 中的哪个系统？\|ZooKeeper 是 CP 系统]]

## BASE 理论是什么？

[BASE 理论](obsidian://open?vault=%E7%AC%94%E8%AE%B0&file=src%2Fconcept%2FBASE) 牺牲了**强一致性**，是对 AP 系统的补充：
- A → BA（基本可用）
	- 分布式系统在出现故障后，保证**核心功能**可用
- C →
	- S：软状态，允许系统出现中间状态
	- E：最终一致性，分区内所有的副本经过**一定时间**后，**最终**到达数据的一致的状态
	
## 如何保证接口的幂等性？

1. [幂等](obsidian://open?vault=%E7%AC%94%E8%AE%B0&file=src%2Fconcept%2F%E5%B9%82%E7%AD%89%E6%80%A7) 概念
	- 指一个接口，多次发起同一个请求，影响的结果都相同
2. 实现方案：
	- **唯一键约束**：通过 MySQL 唯一约束来保证
	- **请求唯一标识**：如相同订单只能支付一次
	- **去重**（日志表）：消费前，判断重复；消费后，记录

## 有哪些分布式事务的实现？

1. 强事务
	- [XA](obsidian://open?vault=%E7%AC%94%E8%AE%B0&file=src%2Funarchived%2FXA)
		- 由分布式事务管理器来统筹所有结点的本地事务
		- 缺点：
			1. **同步阻塞**：事务执行期间所有结点都阻塞
			2. **单点故障**：对分布式事务管理器强依赖
	- [TCC](obsidian://open?vault=%E7%AC%94%E8%AE%B0&file=src%2Funarchived%2FTCC)
		- 将原先业务拆分为三个执行单元：
			1. Try：尝试执行，预留资源
			2. Commit：真正执行业务逻辑
			3. Cancel：回滚操作
		- 缺点：**编程复杂**，对业务的改造和侵入性大
2. 柔性事务
	- 本地消息
		- 将业务逻辑和插入本地消息表在**同一个本地事务**（如 MySQL）完成
		- 并**定时轮询**本地消息表状态进行补偿
	- 可靠消息最终一致性
		- 基于可靠的 MQ 来实现， 如 Rocket MQ
		- 半消息机制：
			1. 半消息**不会立即投递**，而是会等待 Producer 二次确认（commit）后才会投递给 Consumer
			2. Consumer 在消费消息时如果失败，会进行**补偿重试**
			3. **反查**：如果二次确认超时，Broker 会调用 Producer 反查接口确认事务的状态
		- 优点：
			- 将大事务拆分为小事务，一个系统的失败**不会导致整体流程回滚**，只需要针对失败系统做数据修订即可
			- 实现相对简单
