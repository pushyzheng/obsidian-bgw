---
{"dg-publish":true,"dg-permalink":"MySQL 事务","permalink":"/MySQL 事务/"}
---


#数据库 #MySQL 

## 事务的概念是什么？

四大特性（ACID）：
1. ==原子性==
	- 所有操作视为一个**不可分割**的工作单元，要么全成功，要么全失败
	- 实现：通过**[[src/数据库/undo log\|undo log]]**(回滚日志)来实现
2. ==一致性==
	- 事务**执行前后**，数据库的所有数据状态都必须保持一致
3. ==隔离性==
	- 多个事务并发执行时，每个事务的操作**相互隔离**
	- 实现：通过行锁和[[src/数据库/MySQL 锁#MVVC 多版本并发控制机制\|MVVC]]来实现隔离性
4. ==持久性==
	- 一旦事务提交，其对数据库的修改被**永久保存**
	- 实现：通过**[[src/数据库/redo log\|redo log]]**(重做日志)来实现

## 事务的实现原理？

事务是基于 [[src/数据库/redo log\|redo log]] 、 [[src/数据库/undo log\|undo log]]以及 MVCC（保证隔离性）实现的：
1. 原子性、持久性
	- [[src/数据库/redo log\|redo log]]  的[[src/数据库/redo log#什么是两阶段提交\|两阶段提交]]
2. 一致性
	- [[src/数据库/undo log\|undo log]] 实现**回滚**
3. 隔离性
	- [[src/数据库/MySQL 锁#MySQL 中有哪些锁？\|锁机制]]：行锁、表锁
	- [[src/数据库/MySQL 锁#MVVC 多版本并发控制机制\|MVCC 机制]]实现读已提交、可重复读隔离级别
	

## 事务可能导致的错误？

1. ==脏读==
	- 读取到其他事务还**未提交的修改**数据
2. ==不可重复读==
	- 一个事务中两次查询同一记录，返回**不同**数据
3. [[src/数据库/幻读\|幻读]]
	- 事务 A 读取某个**范围**记录时，之后事务 B 在该范围修改
	- 事务 A 再次读取该范围时，出现幻行

## 请你谈谈 MySQL 事务隔离级别，MySQL 的默认隔离级别是什么?

四种隔离级别：
1. ==读未提交 RU==
	- 一个事务可以读取到另一个事务**尚未提交**的数据
	- 会出现脏读、[[src/数据库/幻读\|幻读]]的情况
2. ==读已提交 RC==（Oracle、SQL Server 默认的级别）
	- 允许读取其他事务已经提交的数据
	- 避免了脏读，但仍可能出现不可重复读和幻读
3. ==可重复读 RR==（**InnnoDB** 引擎默认的级别）
	- 保证同一事务中**多次**读取相同数据结果**一致**
	- 避免脏读和不可重复读，但[[src/数据库/幻读\|幻读]]仍可能发生
4. ==串行化 S==
	- 事务按顺序执行
	- **完全避免**脏读、不可重复读和幻读

## MySQL事务隔离级别的实现原理

- 未提交读
	- 没有任何限制
- 已提交读
	- 通过 [[src/数据库/MySQL 锁#MVVC 多版本并发控制机制\|MVVC 多并发版本控制]]来实现，每次[[src/数据库/MySQL 锁#什么是快照读和当前读？\|当前读]]时都生成一个读快照
- 可重复读
	- 事务**开始到结束**都使用同一个视图
	- [[src/数据库/Next-Key 锁\|Next Key 锁（行锁 + 间隙锁）]]
- 串行化
	- **加锁**单线程执行

## 长事务会有那些问题？

1. 回滚段不会被清除
	- 由于 MVCC 的机制，长事务会保留**很老的**事务视图
	- 会占用大量的**存储空间**
2. 占用锁资源
	- 长事务会一直占用**锁资源**，从而影响系统性能