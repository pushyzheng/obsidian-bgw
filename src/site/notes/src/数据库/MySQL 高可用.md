---
{"dg-publish":true,"dg-permalink":"MySQL 高可用","permalink":"/MySQL 高可用/"}
---


#数据库 #MySQL 

## MySQL 的主从同步机制？

MySQL 的[主从复制](obsidian://open?vault=%E7%AC%94%E8%AE%B0&file=src%2Funarchived%2FMySQL%20%E9%AB%98%E5%8F%AF%E7%94%A8)的同步过程：
1. Master 的 **dump 线程**写入 **binlog**
2. Slave 同步 binlog，由 **I/O 线程**写入中继日志
3. 由 **SQL 线程**读取中继日志进行本地回放，完成数据同步

## MySQL 主从同步的三种模式？

1. **异步复制**
	- 主库提交事务后（写入 binlog 并通知从结点后），立即返回客户端
	- 如果未同步完，Master 宕机，会导致数据不一致
2. **同步复制**
	- 主库提交事务后，**所有从结点**必须接收并提交事务后，主库才能继续执行
3. [半同步复制](obsidian://open?vault=%E7%AC%94%E8%AE%B0&file=src%2Funarchived%2FMySQL%20%E5%8D%8A%E5%90%8C%E6%AD%A5%E5%A4%8D%E5%88%B6)
	- 主库**至少接收到一个**从库的 ACK 才视为复制成功

对比：

| 特性                                    | 异步复制 | 同步复制 | 半同步复制 |
| --------------------------------------- | -------- | -------- | ---------- |
| 可靠性                                  | 最低     | 最高     | 比较高     |
| 延迟性                                  | 最低     | 最高     | 比较高     |
| 至少接收到从库多少 ACK <br>才返回客户端 | 0        | 所有     | 1           |

## 为什么会有主从同步延迟？

1. 由于从库中的 SQL 线程是**单线程**
2. 当**主库并发很高**时：SQL 线程的回放速度降低，导致延迟的产生

![WX20220410-114306@2x.png](/img/user/attachments/images/WX20220410-114306@2x.png)

## 主从同步延迟如何处理？

[MySQL 主从复制存在的问题](obsidian://open?vault=%E7%AC%94%E8%AE%B0&file=src%2Funarchived%2FMySQL%20%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98)

1. 代码层面：避免写数据后立即查询数据
2. **二次查询**：先查从库，查不到再查主库
3. **关键业务读走主库**：如注册完之后的登录操作，直接的主库，防止找不到用户

## 为什么要读写分离？

1. **读多写少**：一般业务场景读 QPS 远大于写 QPS
2. **单机并发受限**：无法支撑大量的并发读写