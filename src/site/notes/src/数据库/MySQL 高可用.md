---
{"dg-publish":true,"dg-permalink":"MySQL 高可用","permalink":"/MySQL 高可用/"}
---


#数据库 #MySQL 

## MySQL 的主从同步机制有什么优势？

- ==读写分离==
	- 写主库、读从库，减轻主库的压力
- ==数据备份==
	- 数据热备到多个从结点
- ==高可用==
	- 主库发生故障时，可以快速切换到从库，保障服务的连续性
- ==水平拓展==
	- 方便为从库做水平拓展，提高读并发

## MySQL 的主从同步的过程？

1. 主库的 **dump 线程**写入[[src/数据库/binlog\|binlog]]
2. 从库同步主库的[[src/数据库/binlog\|binlog]]，由 **I/O 线程**下载写入中继日志（Rely log）
3. 由 **SQL 线程**读取中继日志进行本地回放，应用数据变更，完成数据同步

## MySQL 主从同步的三种模式？

1. ==异步复制==
	- 主库提交事务后（写入 binlog 并通知从结点后），**立即**返回客户端
	- 如果未同步完，主库宕机，会导致**数据不一致**
2. ==同步复制==
	- 主库提交事务后，**所有从结点**必须接收并提交事务后，主库才能继续执行
3. ==半同步复制==
	- 主库执行完更新事务后，不立即返回，通过 [[src/数据库/binlog\|binlog]]推送到从库的 relaylog 上
	- 至少接收到**一个从库**的 ACK 才视为事务成功
	- 保证主库的更新数据至少被同步到一个从库上

对比：

| 特性                                    | 异步复制 | 同步复制 | 半同步复制 |
| --------------------------------------- | -------- | -------- | ---------- |
| 可靠性                                  | 最低     | 最高     | 比较高     |
| 延迟性                                  | 最低     | 最高     | 比较高     |
| 至少接收到从库多少 ACK <br>才返回客户端 | 0        | 所有     | 1           |

## 为什么会有主从同步延迟？

1. ==从库单线程重放限制==
	- 5.7之前从库中回放 SQL 的线程是**单线程**
	- 5.7+虽然支持多线程复制，但是某些场景的并行复制仍然可能存在延迟
2. ==大型查询及锁等待==
	- 从库上若有耗时长的查询或者锁冲突，会阻塞同步线程执行 binlog 中的 DDL/DML 语句
3. ==主从负载不均==
	- 当主库**并发很高**时：生成[[src/数据库/binlog\|binlog]]速度快，从库如果性能差或负载高试时，执行 binlog 效率低下

## 主从同步延迟如何处理？

1. ==架构层面==
	- 使用从库的**多线程**复制
	- 避免一次性执行**超大事务**或大批量数据操作：将大事务拆分分批执行
	- 使用**半同步复制**
2. ==代码业务层面==
	- 延迟查询：避免写数据后立即查询数据
	- 二次查询：先查从库，**查不到**再查主库
	- 关键业务读走主库：如注册完之后的登录操作，**显式走主库**，防止找不到用户

## 为什么要读写分离？

读写分离的目的：写操作集中在主库，读操作集中在从库

1. ==提高读性能和系统吞吐量==
	- 大部分业务场景是**读多写少**
	- 单机并发受限：无法支撑大量的并发读写
2. ==缓解锁竞争==
	- 写操作仅涉及行锁和表锁
	- 如果主库同时承担读写，会引起**读写互斥锁冲突**
3. ==提高系统的高可用性和容灾能力==
	- 多个从库可作为**冗余备份**
	- 主库故障，可以切换到从库