---
{"dg-publish":true,"dg-permalink":"最右排名统计","permalink":"/最右排名统计/"}
---


#系统设计

## 题目

背景：最右 App 的主消费场景是推荐，用户每刷新一次会看到 10 条帖子，同时后台会生成一条曝光日志。一条日志对应用户的一次刷新，其中包含 10 个帖子 ID。日志可以从 MQ 中消费得到。

需求：给用户展示最近 24 小时曝光 Top 100 的帖子。

要求：

- 注意 24 小时是一个滑动窗口：每次读取都是最近 24 小时的曝光统计结果 （不必精确到秒，但是误差不应该超过 10 分钟）
- 线上用户读取结果时，接口时延 P99 应该控制在 200ms 以下
- 数量级：4000 万日志，4 亿条曝光，100 万帖子

## 思路

1. 使用 zset 以每小时进行分片排名存储
2. 定时进行归并 zset 数据，取出 Top 100，然后将结果集存储到其他数据结构上
3. 用户实时读取减少响应时间