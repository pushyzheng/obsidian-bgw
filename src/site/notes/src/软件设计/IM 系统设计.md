---
{"dg-publish":true,"dg-permalink":"IM 系统设计","permalink":"/IM 系统设计/"}
---


#系统设计

## 消息可靠抵达机制

数据可靠抵达是个通用性的问题，如 TCP 中可靠性的设计。

> 网络层的可靠性不等同于业务层的可靠性，所以即使底层传输协议是 TCP，仍然有可能在上层的 DB 操作、Cache 会出现丢失的情况。

所以需要保证：
1. ACK 机制
	- 在应用层也实现 ACK 机制，保证业务的可靠，只有当发送端接收到接收端的 ACK 后，才认为消息被成功接收
	- 否则需要根据策略来做重发
2. 超时重传
	- 在本地维护一个等待 ACK 队列，并配合 Timer 超时机制
	- 对超时未 ACK 的消息进行重新投递
3. 去重
	- 由于使用了重传，所以会存在重复投递的情况
	- 通过发送方的唯一 MsgID 来做去重