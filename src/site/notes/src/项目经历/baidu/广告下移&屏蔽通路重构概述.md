---
{"dg-publish":true,"dg-permalink":"广告下移&屏蔽通路重构概述","permalink":"/广告下移&屏蔽通路重构概述/"}
---


#项目 

## 背景

原先广告下移&屏蔽:
- 由**商业侧**来维护词表，词表的数据没有**动态更新**
- 在搜索检索广告请求时下发信号，大搜在**展现层**来做相关的下移&屏蔽的操作

由于存在以下问题，当前机制对搜索用户体验产生了一定影响：
- 商业侧难以及时识别**高需求 query**（涉政、热点、敏感话题、教育等） 或关键卡片场景
- 广告下移&屏蔽的维度不够细：例如分端、不同操作类型、不同卡片维度等
- 词表更新的**时效性不足**，线上频繁出现 BadCase，特别对于时效性的 query
- 搜索体验保障与广告收益之间缺乏良好的**平衡机制**

## 目标与方向

重构的目的：
1. 提升**稳定性**与**时效性**，缩短问题排查路径
	- 通过例行离线任务方式，来更新每日新增的高需求 query
	- 数据托管到用户侧，便于用户侧提升整体排查效率
2. 增强**可观测性**与数据透明度：
	- 在线：增加检索时打点和展现日志，便于排查 BadCase 和数据统计
	- 离线：通过平台化的任务，增强对离线词表更新流程的监控与报警能力
3. 重构后职责更加分明：强化“**用商平衡**”机制
	- 商业侧：负责控制整体的**消费阈值**，把控收益端风险
	- 用户侧：产出高需求词表，并根据 query 需求强度调整**排序策略**，实现更灵活的下移优先级

目标：避免强需求 query 下广告**出现在首位**给搜索用户体验带来的影响，比如：
- **屏蔽**：对广告 0 容忍：涉政、股票，首页不能出现广告
- **下移**：热事件：高考、奥运会、世界杯、天气场景，允许有广告，但是不能在首位

## 方案

### 模块划分

- ==平台配置==：PM 通过评估来配置那些卡片需要进行 query 的挖掘，并允许指定：
	- opid（操作类型）：如下移、屏蔽等
	- range（流量范围）：在端内、端外、PC 生效
	- limit_type（阈值类型）：固定、无线阈值
- ==离线任务==：用户侧根据跑表、计算、排序最终输出高需求性的 query 集合
- ==阈值模块==：商业侧根据评估计算 query，在超出整体阈值（事先用商达成的消费池子）后，截断排名靠后的 query 记录
- ==搜索展现层==：通过读取在线词表记录，获取到当前检索 query 的下移数据，做对应的下移/屏蔽的操作

### 如何挖掘 query

1. 通过 PM 配置资源号来进行挖掘：对搜索展现表（记录了每次搜索的结果的展现数据）来做整体计算，通过计算卡片的置顶率，来最终产出 query + 卡片维度的行数据
2. 由业务（垂类搜索）来提供：通过扩展性的方式，允许业务提供 HDFS 地址来提供 query 集合（更精准地保证高需求性），并在最终做整体合并
3. 平台干预：支持通过平台配置的方式，可以弥补一些 BadCase/长尾的需求

### 如何定义高需求性

- 置顶率：query PV / 卡片在首位的 PV，大于 **50%** 则理解为高需求，低于 50% 的 query 将会被过滤
- 排序：默认根据 query 的总 PV 进行倒排，或配置的特权的卡片等策略

### 干预功能实现

- ==词表聚合==：有些垂类业务、需求场景需要保证每天的 query 聚合，形成**存量词表**
- ==query 回捞==
	- 商业侧通过**后评估**有些 query 可能是高收入的 query
	- 为了保证不损失过多收入，允许通过平台配置，对这部分进行**剔除**，保证体验/收入平衡
- ==排查工具==：通过内部的低代码平台搭建排查工具，提供给 PM 能够直接通过搜索检索的 LogId 排查未下移的原因

## 收益

- 日均：覆盖 300w+ 的真实下移 PV
- 2024 高考
	- 整个避让期间，对部分民办院校词、非高考需求词进行 query 捞回，挽回商业收入 **2250w**
	- 覆盖 1300w query，在高考期间下移成功覆盖 2 亿

## 问题

### 项目的亮点？

- 平台化离线任务：使用内部的 EJOB 平台，提高任务的稳定性、可用性，避免单点故障
- 为【高考专项】项目开发累计词表功能， 最大限度的满足高考期间的长尾需求，避免广告出现影响用户体验

### 项目的难点？

- 在使用 Hadoop 进行 MapReduce 计算时，由于 Reducer 只能保证单个文件中部分有序，但是最终输出的词表会以 PV 来进行排序，则无法保证整体有序

### 项目的展望？